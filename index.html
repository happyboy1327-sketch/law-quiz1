<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë²•ë¥  3ì§€ì„ ë‹¤ í€´ì¦ˆ</title>
    
    <!-- í°íŠ¸ ë³€ê²½: Pretendard í°íŠ¸ ë¡œë“œ -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Pretendard í°íŠ¸ ì„¤ì • ì ìš© */
        body {
            font-family: 'Pretendard', 'Malgun Gothic', 'Dotum', sans-serif;
            background-color: #e5f4f7; /* ì•„ì£¼ ì—°í•œ ì²­ë¡ìƒ‰ ë°°ê²½ */
            color: #1f2937;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .card {
            background-color: #ffffff;
            /* ë” ê¹Šì€ ê·¸ë¦¼ìë¡œ ëª¨ë˜í•œ ëŠë‚Œ ê°•ì¡° */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        /* ë‹µë³€ ë²„íŠ¼ ìŠ¤íƒ€ì¼: Black Textë¥¼ ìœ„í•´ ë°°ê²½ì„ ë°ê²Œ ì¡°ì • */
        .btn-choice {
            background-color: #d1eaea; /* Light Teal for black text */
            transition: all 0.2s ease-in-out;
            color: #000000; /* Black text for maximum visibility */
            font-weight: 700; /* Increased weight for visibility */
        }
        .btn-choice:hover:not(:disabled) {
            background-color: #aae0e0; /* Darker light teal on hover */
            transform: translateY(-2px); /* ì•½ê°„ì˜ ë¦¬í”„íŠ¸ íš¨ê³¼ */
        }
        
        /* ì„ íƒëœ ì •ë‹µ/ì˜¤ë‹µ ë²„íŠ¼: ë°°ê²½ì´ ì§™ìœ¼ë¯€ë¡œ í…ìŠ¤íŠ¸ëŠ” í°ìƒ‰ì„ ìœ ì§€í•´ì•¼ ê°€ë…ì„±ì´ ì¢‹ìŠµë‹ˆë‹¤. */
        .btn-correct {
            background-color: #0d9488; /* Teal-600 (Dark) */
            color: #ffffff; /* White text for contrast on dark background */
        }
        .btn-incorrect {
            background-color: #dc2626; /* Red (Dark) */
            color: #ffffff; /* White text for contrast on dark background */
        }
        
        /* ì •ë‹µ ì„ íƒ ì‹œ, ì •ë‹µì„ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ì„ íƒì§€ë¥¼ ê°€ì¥ ëª…í™•í•˜ê²Œ í‘œì‹œí•˜ëŠ” ìŠ¤íƒ€ì¼ */
        .btn-subdued {
            background-color: #f3f4f6; /* ë°°ê²½ì€ íë¦¿í•˜ê²Œ ìœ ì§€ */
            color: #000000; /* í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ì ˆëŒ€ ê²€ì€ìƒ‰ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ìµœëŒ€ ëŒ€ë¹„ í™•ë³´ */
            font-weight: 700; /* í°íŠ¸ êµµê¸°ë¥¼ ë” ë‘ê»ê²Œ ì„¤ì •í•˜ì—¬ ê°€ë…ì„± ê°•í™” */
            box-shadow: none;
            cursor: default;
        }

        .btn-next {
            background-color: #0d9488; /* Teal-600 */
            transition: background-color 0.2s;
        }
        .btn-next:hover {
            background-color: #0f766e; /* Teal-700 */
        }
        .btn-review {
            background-color: #5b21b6; /* Violet-700 */
            transition: background-color 0.2s;
        }
        .btn-review:hover {
            background-color: #4c1d95; /* Violet-800 */
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0d9488; /* Teal ìƒ‰ìƒ ìŠ¤í”¼ë„ˆ */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app" class="card p-6 sm:p-10 w-full max-w-lg mx-4 rounded-xl">
        <h1 class="text-3xl font-extrabold mb-6 text-center text-teal-800">ë²•ë¥  3ì§€ì„ ë‹¤ í€´ì¦ˆ</h1>

        <!-- ì ìˆ˜ ë° ë³µìŠµ ë¬¸ì œ í‘œì‹œ ì˜ì—­ -->
        <div class="flex flex-col sm:flex-row justify-between items-stretch gap-3 mb-6">
            <div class="flex-1 p-4 bg-teal-100 rounded-lg flex items-center justify-between shadow-inner">
                <span class="text-lg font-bold text-teal-800">ì ìˆ˜:</span>
                <span id="scoreDisplay" class="text-3xl font-extrabold text-teal-600">0 / 0</span>
            </div>
            <div class="w-full sm:w-auto p-4 bg-gray-100 rounded-lg flex items-center justify-between shadow-inner">
                <span class="text-sm font-medium text-gray-700">ë³µìŠµ ë¬¸ì œ:</span>
                <span id="reviewCount" class="text-xl font-bold text-gray-600">0ê°œ</span>
            </div>
        </div>

        <!-- í€´ì¦ˆ í‘œì‹œ ì˜ì—­ (ë¬¸ì œ, ë¡œë”©) -->
        <!-- Quiz Boxë¥¼ ê°ì‹¸ì„œ ì „ì²´ë¥¼ í•œ ë²ˆì— ìˆ¨ê¸°ê±°ë‚˜ í‘œì‹œí•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. -->
        <div id="quizBox" class="bg-white p-5 rounded-xl border-2 border-teal-200 min-h-[150px] flex flex-col justify-center mb-6 shadow-md">
            <p id="questionText" class="text-xl font-semibold text-black text-center">
                í€´ì¦ˆë¥¼ ì‹œì‘í•˜ë ¤ë©´ 'ì‹œì‘í•˜ê¸°' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.
            </p>
            <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
            <div id="loadingIndicator" class="hidden flex flex-col justify-center items-center py-5">
                <div class="spinner"></div>
                <span class="mt-3 text-teal-600 font-medium">ë¬¸ì œ ìƒì„± ì¤‘... (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”)</span>
            </div>
        </div>

        <!-- ì •ë‹µ í™•ì¸ ë° í•´ì„¤ ì˜ì—­ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€) -->
        <div id="feedbackContainer" class="hidden p-4 rounded-lg mt-4 shadow-inner" role="alert">
            <p id="feedbackMessage" class="font-bold mb-2"></p>
            <p id="explanationText" class="text-sm text-gray-700"></p>
        </div>

        <!-- ë‹µë³€ ë²„íŠ¼ ì˜ì—­ (3ì§€ì„ ë‹¤í˜•) -->
        <div class="grid grid-cols-1 gap-4" id="answerButtons">
            <!-- '1' ë²„íŠ¼ -->
            <button id="btnA" class="btn-choice py-3 font-semibold rounded-lg shadow-lg transition duration-150" disabled>
                1. 
            </button>
            <!-- '2' ë²„íŠ¼ -->
            <button id="btnB" class="btn-choice py-3 font-semibold rounded-lg shadow-lg transition duration-150" disabled>
                2. 
            </button>
            <!-- '3' ë²„íŠ¼ -->
            <button id="btnC" class="btn-choice py-3 font-semibold rounded-lg shadow-lg transition duration-150" disabled>
                3. 
            </button>
        </div>
        
        <!-- ë³µìŠµ ë¬¸ì œ ëª©ë¡ í‘œì‹œ ì˜ì—­ (ìƒˆë¡œ ì¶”ê°€ë¨) -->
        <div id="reviewListContainer" class="hidden mt-6">
            <h2 class="text-2xl font-bold text-violet-700 mb-4 border-b-4 border-violet-200 pb-2">âŒ í‹€ë¦° ë¬¸ì œ ëª©ë¡</h2>
            <div id="reviewItems" class="space-y-6">
                <!-- ë³µìŠµ ë¬¸ì œê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì˜ì—­ -->
        <div class="flex flex-col gap-3 mt-6">
            <!-- ë‹¤ìŒ ë¬¸ì œ/ì‹œì‘ ë²„íŠ¼ -->
            <button id="btnNext" class="btn-next w-full py-3 text-white font-bold rounded-lg shadow-xl transition duration-150 transform hover:scale-[1.01]">
                ì‹œì‘í•˜ê¸°
            </button>
            
            <!-- ë³µìŠµ ëª¨ë“œ ë²„íŠ¼ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€/ë¹„í™œì„±í™”) -->
            <button id="btnReviewMode" class="btn-review w-full py-3 text-white font-bold rounded-lg shadow-xl transition duration-150 transform hover:scale-[1.01] hidden" disabled>
                ë³µìŠµ ëª¨ë“œ ì‹œì‘
            </button>
        </div>

    </div>

    <script>
        // API Key (Canvas í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤)
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤
        const REVIEW_STORAGE_KEY = 'legalReviewQuestions';
        // ì´ë¯¸ ì¶œì œëœ ë¬¸ì œ ê¸°ë¡ì„ ì €ì¥í•  í‚¤ (ì¤‘ë³µ ë°©ì§€ìš©)
        const ASKED_HISTORY_KEY = 'legalAskedHistory';

        // ì •ì  ëŒ€ì²´ í€´ì¦ˆ ë°ì´í„° (ë¡œì»¬ ì‹¤í–‰ í™˜ê²½ ë˜ëŠ” API ì‹¤íŒ¨/ë°˜ë³µ ì¶œì œ ì‹œ ì‚¬ìš©)
        // ê¸°ì¡´ 5ê°œì—ì„œ 10ê°œë¡œ ëŒ€í­ í™•ì¥í•˜ì—¬ ìƒˆë¡œìš´ ë¬¸ì œê°€ ì—†ì„ ê°€ëŠ¥ì„±ì„ ì¤„ì„
        const STATIC_QUIZ_DATA = [
            {
                "question": "ê³„ì•½ì„œì— ì„œëª…í•˜ì§€ ì•Šê³  êµ¬ë‘ë¡œ í•©ì˜í•œ ê²½ìš°ì—ë„ ë²•ì  íš¨ë ¥ì´ ë°œìƒí•˜ë‚˜ìš”?",
                "options": ["1. ì ˆëŒ€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.", "2. êµ¬ë‘ í•©ì˜ë§Œìœ¼ë¡œë„ ë²•ì  íš¨ë ¥ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.", "3. ê³µì¦ì„ ë°›ì•„ì•¼ë§Œ íš¨ë ¥ì´ ë°œìƒí•œë‹¤."],
                "answer": "2",
                "explanation": "ëŒ€ë¶€ë¶„ì˜ ê³„ì•½ì€ êµ¬ë‘ë¡œ í•©ì˜í•´ë„ ë²•ì  íš¨ë ¥ì´ ë°œìƒí•©ë‹ˆë‹¤(ë‚™ì„±ê³„ì•½). ë‹¤ë§Œ, ë¶€ë™ì‚° ë§¤ë§¤, ë³´ì¦ ê³„ì•½ ë“± ì¼ë¶€ ì¤‘ìš”í•œ ê³„ì•½ì€ ì„œë©´ì„ ìš”êµ¬í•˜ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤. êµ¬ë‘ ê³„ì•½ì˜ ë¬¸ì œëŠ” ì…ì¦ì´ ì–´ë µë‹¤ëŠ” ì ì…ë‹ˆë‹¤."
            },
            {
                "question": "ë§Œ 19ì„¸ ë¯¸ë§Œì˜ ë¯¸ì„±ë…„ìê°€ ë¶€ëª¨ ë™ì˜ ì—†ì´ ê³„ì•½ì„ ì²´ê²°í–ˆì„ ë•Œ, ì´ ê³„ì•½ì˜ íš¨ë ¥ì€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?",
                "options": ["1. ë‹¹ì—°íˆ ë¬´íš¨ì´ë‹¤.", "2. ë¯¸ì„±ë…„ì ì¸¡ì—ì„œ ì·¨ì†Œí•  ìˆ˜ ìˆë‹¤.", "3. ë¶€ëª¨ê°€ ê³„ì•½ ë‚´ìš©ì„ ì•Œì•˜ë‹¤ë©´ ìœ íš¨í•˜ë‹¤."],
                "answer": "2",
                "explanation": "ë¯¸ì„±ë…„ìê°€ ë²•ì •ëŒ€ë¦¬ì¸(ë¶€ëª¨ ë“±)ì˜ ë™ì˜ ì—†ì´ ì²´ê²°í•œ ê³„ì•½ì€ ì›ì¹™ì ìœ¼ë¡œ ë¯¸ì„±ë…„ì ë³¸ì¸ì´ë‚˜ ë²•ì •ëŒ€ë¦¬ì¸ì´ 'ì·¨ì†Œ'í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë¯¸ì„±ë…„ìë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•œ ë¯¼ë²•ì˜ ê·œì •ì…ë‹ˆë‹¤."
            },
            {
                "question": "ê¸¸ê±°ë¦¬ì—ì„œ ì£¼ìš´ ì§€ê°‘ì„ ê²½ì°°ì„œì— ì‹ ê³ í•˜ì§€ ì•Šê³  ìì‹ ì´ ì‚¬ìš©í•˜ë©´ ì–´ë–¤ ì£„ì— í•´ë‹¹í•˜ë‚˜ìš”?",
                "options": ["1. ì ìœ ì´íƒˆë¬¼íš¡ë ¹ì£„", "2. ì ˆë„ì£„", "3. ë¬´ì£„ì´ë‹¤."],
                "answer": "1",
                "explanation": "ì ìœ ì´íƒˆë¬¼íš¡ë ¹ì£„ëŠ” íƒ€ì¸ì´ ìƒì–´ë²„ë¦° ë¬¼ê±´ì„ ìŠµë“í•˜ê³ ë„ ì†Œìœ ìì—ê²Œ ëŒë ¤ì£¼ì§€ ì•Šê±°ë‚˜ ê²½ì°°ì— ì‹ ê³ í•˜ì§€ ì•Šê³  ì˜ë“í•  ë•Œ ì„±ë¦½í•˜ëŠ” ë²”ì£„ì…ë‹ˆë‹¤. ì ˆë„ì£„ëŠ” íƒ€ì¸ì˜ 'ì ìœ ' í•˜ì— ìˆëŠ” ë¬¼ê±´ì„ í›”ì¹  ë•Œ ì„±ë¦½í•©ë‹ˆë‹¤."
            },
            {
                "question": "ì¸í„°ë„· ê²Œì‹œíŒì— íƒ€ì¸ì˜ ëª…ì˜ˆë¥¼ í›¼ì†í•˜ëŠ” ë‚´ìš©ì„ ê²Œì‹œí–ˆì„ ê²½ìš°, ì‚¬ì‹¤ì´ë¼ë„ ì²˜ë²Œë°›ì„ ìˆ˜ ìˆë‚˜ìš”?",
                "options": ["1. ì‚¬ì‹¤ì´ë©´ ëª…ì˜ˆí›¼ì†ì£„ë¡œ ì²˜ë²Œë°›ì§€ ì•ŠëŠ”ë‹¤.", "2. ì‚¬ì‹¤ì´ë”ë¼ë„ ê³µìµê³¼ ë¬´ê´€í•˜ë©´ ì²˜ë²Œë°›ì„ ìˆ˜ ìˆë‹¤.", "3. ì§„ì‹¤í•œ ì‚¬ì‹¤ì´ë©´ ë¬´ì¡°ê±´ ë¬´ì£„ì´ë‹¤."],
                "answer": "2",
                "explanation": "í˜•ë²•ìƒ ëª…ì˜ˆí›¼ì†ì£„ëŠ” 'ê³µì—°íˆ ì‚¬ì‹¤ì„ ì ì‹œí•˜ì—¬' ì‚¬ëŒì˜ ëª…ì˜ˆë¥¼ í›¼ì†í•  ê²½ìš° ì„±ë¦½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‚¬ì‹¤ì´ë¼ë„ ì²˜ë²Œë°›ì„ ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ì§„ì‹¤í•œ ì‚¬ì‹¤ ì ì‹œ ëª…ì˜ˆí›¼ì†ì£„ì— í•´ë‹¹í•©ë‹ˆë‹¤. ë‹¤ë§Œ, ê·¸ ì‚¬ì‹¤ì´ ì˜¤ë¡œì§€ ê³µê³µì˜ ì´ìµì— ê´€í•œ ê²ƒì¼ ë•Œë§Œ ìœ„ë²•ì„±ì´ ì¡°ê°ë˜ì–´ ì²˜ë²Œë°›ì§€ ì•ŠìŠµë‹ˆë‹¤."
            },
            {
                "question": "ì•„íŒŒíŠ¸ ì¸µê°„ì†ŒìŒ ë¬¸ì œë¡œ ê³ í†µë°›ì„ ë•Œ, ë²•ì ìœ¼ë¡œ ì†Œì†¡ ì™¸ì— í•´ê²°í•  ìˆ˜ ìˆëŠ” ê³µì‹ì ì¸ ì ˆì°¨ê°€ ìˆë‚˜ìš”?",
                "options": ["1. ì†Œì†¡ ì™¸ì—ëŠ” ì‚¬ì ìœ¼ë¡œ í•´ê²°í•´ì•¼ í•œë‹¤.", "2. í™˜ê²½ë¶„ìŸì¡°ì •ìœ„ì›íšŒì— ì¡°ì •ì„ ì‹ ì²­í•  ìˆ˜ ìˆë‹¤.", "3. ì˜¤ì§ ê²½ì°°ì— ì‹ ê³ í•˜ëŠ” ê²ƒë§Œ ê°€ëŠ¥í•˜ë‹¤."],
                "answer": "2",
                "explanation": "ì¸µê°„ì†ŒìŒ ë¬¸ì œì˜ ê²½ìš°, ë¯¼ì‚¬ì†Œì†¡ ì´ì™¸ì—ë„ ì¤‘ì•™í™˜ê²½ë¶„ìŸì¡°ì •ìœ„ì›íšŒë‚˜ ì§€ë°©í™˜ê²½ë¶„ìŸì¡°ì •ìœ„ì›íšŒì— ì¡°ì • ì‹ ì²­ì„ í†µí•´ ë¹„êµì  ë¹ ë¥´ê³  ê°„í¸í•˜ê²Œ í”¼í•´ ë°°ìƒì´ë‚˜ ì†ŒìŒ ì €ê° ì¡°ì¹˜ ë“±ì„ ìš”êµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            },
            {
                "question": "ì•„íŒŒíŠ¸ ê³µìš© ë³µë„ì— ê°œì¸ ìì „ê±°ë¥¼ ì¥ê¸°ê°„ ë³´ê´€í•˜ëŠ” ê²ƒì€ ë²•ì ìœ¼ë¡œ ë¬¸ì œê°€ ë˜ë‚˜ìš”?",
                "options": ["1. ê°œì¸ ë¬¼í’ˆì´ë¼ ë¬¸ì œê°€ ì—†ë‹¤.", "2. ì†Œë°© ê´€ë ¨ ë²•ê·œ ìœ„ë°˜ìœ¼ë¡œ ê³¼íƒœë£Œ ëŒ€ìƒì´ ë  ìˆ˜ ìˆë‹¤.", "3. ê´€ë¦¬ì†Œì˜ í—ˆê°€ë¥¼ ë°›ìœ¼ë©´ ë¬¸ì œê°€ ì—†ë‹¤."],
                "answer": "2",
                "explanation": "ì•„íŒŒíŠ¸ ê³µìš© ê³µê°„(ë³µë„, ê³„ë‹¨)ì— ë¬¼ê±´ì„ ìŒ“ì•„ë‘ëŠ” í–‰ìœ„ëŠ” ì†Œë°©ì‹œì„¤ ì„¤ì¹˜ ë° ê´€ë¦¬ì— ê´€í•œ ë²•ë¥  ìœ„ë°˜ìœ¼ë¡œ ê°„ì£¼ë˜ì–´ ê³¼íƒœë£Œ ì²˜ë¶„ ëŒ€ìƒì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” í™”ì¬ ë°œìƒ ì‹œ í”¼ë‚œì— ì§€ì¥ì„ ì¤„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤."
            },
            {
                "question": "íƒ€ì¸ì˜ ì´ˆìƒê¶Œì´ ì¹¨í•´ë˜ëŠ” ì‚¬ì§„ì„ ì¸í„°ë„·ì— ì˜¬ë ¸ì„ ê²½ìš°, í”¼í•´ìê°€ í˜•ì‚¬ ê³ ì†Œë¥¼ í•  ìˆ˜ ìˆë‚˜ìš”?",
                "options": ["1. ì´ˆìƒê¶Œ ì¹¨í•´ëŠ” í˜•ì‚¬ ì²˜ë²Œ ëŒ€ìƒì´ë¯€ë¡œ ê³ ì†Œ ê°€ëŠ¥í•˜ë‹¤.", "2. ì¼ë°˜ì ìœ¼ë¡œ ì´ˆìƒê¶Œ ì¹¨í•´ëŠ” ë¯¼ì‚¬ìƒ ì†í•´ë°°ìƒ ì²­êµ¬ì˜ ëŒ€ìƒì´ë‹¤.", "3. ì‚¬ì§„ì´ í›¼ì†ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ë²•ì  ë¬¸ì œê°€ ì—†ë‹¤."],
                "answer": "2",
                "explanation": "ì´ˆìƒê¶Œì€ í—Œë²•ìƒ í–‰ë³µì¶”êµ¬ê¶Œì˜ í•œ ë‚´ìš©ìœ¼ë¡œì„œ ì‚¬ë²•ìƒ ê¶Œë¦¬(ë¯¼ì‚¬)ì´ë©°, í˜•ì‚¬ ì²˜ë²Œ ëŒ€ìƒì´ ë˜ëŠ” ë³„ë„ì˜ ë²•ê·œ(ì˜ˆ: ì •ë³´í†µì‹ ë§ë²•ìƒ ëª…ì˜ˆí›¼ì† ë“±)ì— í•´ë‹¹í•˜ì§€ ì•ŠëŠ” í•œ, ì¼ë°˜ì ìœ¼ë¡œ ë¯¼ì‚¬ìƒ ì†í•´ë°°ìƒ ì²­êµ¬ ë˜ëŠ” ê²Œì‹œë¬¼ ì‚­ì œ ìš”ì²­(ê°€ì²˜ë¶„)ì„ í†µí•´ í•´ê²°í•˜ê²Œ ë©ë‹ˆë‹¤."
            },
            {
                "question": "SNSì—ì„œ íŠ¹ì •ì¸ì„ ì‚¬ì¹­í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê±°ë‚˜ í™œë™í•œ í–‰ìœ„ëŠ” ì–´ë–¤ ë²•ë¥ ì— ì˜í•´ ì²˜ë²Œë  ìˆ˜ ìˆë‚˜ìš”?",
                "options": ["1. ì£¼ê±°ì¹¨ì…ì£„ê°€ ì ìš©ëœë‹¤.", "2. ì •ë³´í†µì‹ ë§ ì´ìš©ì´‰ì§„ ë° ì •ë³´ë³´í˜¸ ë“±ì— ê´€í•œ ë²•ë¥  ìœ„ë°˜ìœ¼ë¡œ ì²˜ë²Œë  ìˆ˜ ìˆë‹¤.", "3. ì‚¬ì¹­ í–‰ìœ„ëŠ” ë²•ì  ì²˜ë²Œ ëŒ€ìƒì´ ì•„ë‹ˆë‹¤."],
                "answer": "2",
                "explanation": "ì •ë³´í†µì‹ ë§ë²• ì œ49ì¡°ì˜7(ë¶€ì • ì ‘ê·¼ ë° ì‚¬ì¹­ ê¸ˆì§€)ì— ë”°ë¼, ì •ë³´í†µì‹ ë§ì„ ì´ìš©í•˜ì—¬ íƒ€ì¸ì„ ì‚¬ì¹­í•˜ì—¬ ì •ë³´ë¥¼ ê²Œì‹œí•˜ê±°ë‚˜ ì†¡ì‹ í•˜ëŠ” í–‰ìœ„ëŠ” ì²˜ë²Œ ëŒ€ìƒì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ê°œì¸ì •ë³´ ë³´í˜¸ ë° ëª…ì˜ˆ ë³´í˜¸ë¥¼ ìœ„í•œ ê²ƒì…ë‹ˆë‹¤."
            },
            {
                "question": "ì¹œêµ¬ê°€ ì‹¤ìˆ˜ë¡œ ë‚´ ë¬¼ê±´ì„ ë¶€ì‰ˆì„ ë•Œ, ì†í•´ë°°ìƒ ì²­êµ¬ëŠ” ëª‡ ë…„ ì•ˆì— í•´ì•¼ í•˜ë‚˜ìš”?",
                "options": ["1. ì†í•´ ë° ê°€í•´ìë¥¼ ì•ˆ ë‚ ë¡œë¶€í„° 3ë…„, ë¶ˆë²•í–‰ìœ„ê°€ ìˆì€ ë‚ ë¡œë¶€í„° 10ë…„ì´ë‹¤.", "2. ì˜¤ì§ 1ë…„ ì´ë‚´ì—ë§Œ ì²­êµ¬í•  ìˆ˜ ìˆë‹¤.", "3. 20ë…„ ì´ë‚´ì—ëŠ” ì–¸ì œë“  ê°€ëŠ¥í•˜ë‹¤."],
                "answer": "1",
                "explanation": "ë¯¼ë²• ì œ766ì¡°ì— ë”°ë¼ ë¶ˆë²•í–‰ìœ„ë¡œ ì¸í•œ ì†í•´ë°°ìƒì²­êµ¬ê¶Œì€ í”¼í•´ìë‚˜ ê·¸ ë²•ì •ëŒ€ë¦¬ì¸ì´ ì†í•´ ë° ê°€í•´ìë¥¼ ì•ˆ ë‚ ë¡œë¶€í„° 3ë…„ê°„ í–‰ì‚¬í•˜ì§€ ì•Šê±°ë‚˜, ë¶ˆë²•í–‰ìœ„ë¥¼ í•œ ë‚ ë¡œë¶€í„° 10ë…„ì„ ê²½ê³¼í•˜ë©´ ì‹œíš¨ë¡œ ì†Œë©¸í•©ë‹ˆë‹¤."
            },
            {
                "question": "ì˜¨ë¼ì¸ ì‡¼í•‘ëª°ì—ì„œ êµ¬ë§¤í•œ ë¬¼ê±´ì„ ë‹¨ìˆœ ë³€ì‹¬ìœ¼ë¡œ ë°˜í’ˆí•  ë•Œ, ì™•ë³µ ë°°ì†¡ë¹„ë¥¼ ëˆ„ê°€ ë¶€ë‹´í•´ì•¼ í•˜ë‚˜ìš”?",
                "options": ["1. íŒë§¤ìê°€ ì™•ë³µ ë°°ì†¡ë¹„ë¥¼ ëª¨ë‘ ë¶€ë‹´í•´ì•¼ í•œë‹¤.", "2. ì†Œë¹„ìê°€ ì™•ë³µ ë°°ì†¡ë¹„ë¥¼ ëª¨ë‘ ë¶€ë‹´í•´ì•¼ í•œë‹¤.", "3. ì†Œë¹„ìì™€ íŒë§¤ìê°€ ë°˜ë°˜ì”© ë¶€ë‹´í•´ì•¼ í•œë‹¤."],
                "answer": "2",
                "explanation": "ì „ììƒê±°ë˜ ë“±ì—ì„œì˜ ì†Œë¹„ìë³´í˜¸ì— ê´€í•œ ë²•ë¥ ì— ë”°ë¼ ì†Œë¹„ìì˜ ë‹¨ìˆœ ë³€ì‹¬ìœ¼ë¡œ ì¸í•œ ì²­ì•½ì² íšŒ(í™˜ë¶ˆ)ì˜ ê²½ìš°, ìƒí’ˆ ë°˜í™˜ì— í•„ìš”í•œ ë¹„ìš©(ì™•ë³µ ë°°ì†¡ë¹„ ë“±)ì€ ì†Œë¹„ìê°€ ë¶€ë‹´í•˜ëŠ” ê²ƒì´ ì›ì¹™ì…ë‹ˆë‹¤."
            }
        ];


        // í€´ì¦ˆ ë°ì´í„° ë° ìƒíƒœ ë³€ìˆ˜
        let totalQuestions = 0; 
        let availableQuestions = []; 
        let currentQuestion = null; 
        let score = 0;
        let isAnswered = false; 
        let isReviewMode = false; // ë³µìŠµ ëª¨ë“œ ìƒíƒœ

        // DOM ìš”ì†Œ ìºì‹±
        const quizBox = document.getElementById('quizBox'); // í€´ì¦ˆ ì§ˆë¬¸ì„ ê°ì‹¸ëŠ” ë°•ìŠ¤
        const questionText = document.getElementById('questionText');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const answerButtonsContainer = document.getElementById('answerButtons'); 
        const btnNext = document.getElementById('btnNext');
        const btnReviewMode = document.getElementById('btnReviewMode'); // ë³µìŠµ ëª¨ë“œ ë²„íŠ¼
        const reviewCountDisplay = document.getElementById('reviewCount'); // ë³µìŠµ ë¬¸ì œ ê°œìˆ˜ í‘œì‹œ
        const feedbackContainer = document.getElementById('feedbackContainer');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const explanationText = document.getElementById('explanationText');
        
        // ìƒˆë¡œ ì¶”ê°€ëœ ë³µìŠµ ëª©ë¡ ìš”ì†Œ
        const reviewListContainer = document.getElementById('reviewListContainer');
        const reviewItems = document.getElementById('reviewItems');

        // 3ì§€ì„ ë‹¤ ë²„íŠ¼ ë°°ì—´
        const choiceButtons = [
            { id: 'btnA', element: document.getElementById('btnA'), choice: '1' },
            { id: 'btnB', element: document.getElementById('btnB'), choice: '2' },
            { id: 'btnC', element: document.getElementById('btnC'), choice: '3' }
        ];

        /**
         * ë¡œë”© ì¸ë””ì¼€ì´í„°ë¥¼ ë³´ì—¬ì£¼ê³  í€´ì¦ˆ ìš”ì†Œë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
         */
        function showLoading() {
            quizBox.classList.remove('hidden'); // ë¡œë”©ì„ ìœ„í•´ í€´ì¦ˆ ë°•ìŠ¤ ìì²´ëŠ” í‘œì‹œ
            questionText.classList.add('hidden');
            answerButtonsContainer.classList.add('hidden');
            reviewListContainer.classList.add('hidden'); // ë³µìŠµ ëª©ë¡ ìˆ¨ê¹€
            loadingIndicator.classList.remove('hidden');
            btnNext.disabled = true;
            btnReviewMode.disabled = true;
            btnNext.textContent = "ë¬¸ì œ ìƒì„± ì¤‘...";
            hideFeedback();
        }

        /**
         * ë¡œë”© ì¸ë””ì¼€ì´í„°ë¥¼ ìˆ¨ê¸°ê³  í€´ì¦ˆ ìš”ì†Œë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
         */
        function hideLoading() {
            loadingIndicator.classList.add('hidden');
            questionText.classList.remove('hidden');
            answerButtonsContainer.classList.remove('hidden');
            quizBox.classList.remove('hidden'); // í€´ì¦ˆ ë°•ìŠ¤ í‘œì‹œ
            btnNext.disabled = false;
            btnReviewMode.disabled = false;
        }
        
        // =================================================================
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬ í•¨ìˆ˜ (ë³µìŠµ ë° ì¤‘ë³µ ë°©ì§€)
        // =================================================================

        /**
         * ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë³µìŠµ ë¬¸ì œ ëª©ë¡(ë°°ì—´)ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
         * @returns {Array} ë³µìŠµ ë¬¸ì œ ë°°ì—´
         */
        function getReviewQuestions() {
            try {
                const stored = localStorage.getItem(REVIEW_STORAGE_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë³µìŠµ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", e);
                return [];
            }
        }
        
        /**
         * í‹€ë¦° ë¬¸ì œë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ëª©ë¡(ë°°ì—´)ì— ì €ì¥í•©ë‹ˆë‹¤. (ì¤‘ë³µ ë°©ì§€)
         * @param {object} question - í‹€ë¦° ë¬¸ì œ ê°ì²´
         */
        function saveIncorrectQuestion(question) {
            let questions = getReviewQuestions();
            // ì§ˆë¬¸ ë‚´ìš©ì´ ì™„ì „íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ì—ë§Œ ì¤‘ë³µìœ¼ë¡œ ê°„ì£¼í•˜ì—¬ ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            if (!questions.some(q => q.question.trim() === question.question.trim())) {
                questions.push(question);
                try {
                    localStorage.setItem(REVIEW_STORAGE_KEY, JSON.stringify(questions));
                    updateReviewModeUI();
                } catch (e) {
                    console.error("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ë³µìŠµ ë¬¸ì œë¥¼ ì €ì¥í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", e);
                }
            }
        }

        /**
         * ì´ë¯¸ ì¶œì œëœ ë¬¸ì œì˜ ì§ˆë¬¸ í…ìŠ¤íŠ¸ ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
         * @returns {Array<string>} ì§ˆë¬¸ í…ìŠ¤íŠ¸ ë°°ì—´
         */
        function getAskedHistory() {
            try {
                const stored = localStorage.getItem(ASKED_HISTORY_KEY);
                // ìµœëŒ€ 20ê°œì˜ ì§ˆë¬¸ë§Œ ìœ ì§€
                return stored ? JSON.parse(stored).slice(0, 20) : [];
            } catch (e) {
                return [];
            }
        }

        /**
         * ìƒˆë¡œ ì¶œì œëœ ë¬¸ì œë“¤ì„ ê¸°ë¡ì— ì¶”ê°€í•˜ê³  ê¸°ë¡ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         * @param {Array<object>} newQuestions - ìƒˆë¡œ ì¶œì œëœ ë¬¸ì œ ê°ì²´ ë°°ì—´
         */
        function updateAskedHistory(newQuestions) {
            let history = getAskedHistory();
            const newTexts = newQuestions.map(q => q.question.trim());

            // ìƒˆ ì§ˆë¬¸ì„ ì•ì— ì¶”ê°€
            history = [...newTexts, ...history];

            // ì¤‘ë³µ ì œê±° ë° ìµœëŒ€ 20ê°œë¡œ ì œí•œ
            history = Array.from(new Set(history)).slice(0, 20); 

            try {
                localStorage.setItem(ASKED_HISTORY_KEY, JSON.stringify(history));
            } catch (e) {
                console.error("ì¶œì œ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨", e);
            }
        }
        
        /**
         * ë³µìŠµ ëª¨ë“œ UI (ë¬¸ì œ ìˆ˜)ë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  ë²„íŠ¼ ìƒíƒœë¥¼ ì¡°ì •í•©ë‹ˆë‹¤.
         */
        function updateReviewModeUI() {
            const count = getReviewQuestions().length;
            reviewCountDisplay.textContent = `${count}ê°œ`;
            
            // ì¼ë°˜ ëª¨ë“œì´ê³ , ì €ì¥ëœ ë¬¸ì œê°€ ìˆì„ ë•Œë§Œ ë³µìŠµ ëª¨ë“œ ë²„íŠ¼ì„ í‘œì‹œ/í™œì„±í™”í•©ë‹ˆë‹¤.
            if (!isReviewMode && count > 0) {
                 btnReviewMode.disabled = false;
                 btnReviewMode.classList.remove('hidden');
                 btnReviewMode.textContent = `ë³µìŠµ ëª¨ë“œ ì‹œì‘ (${count}ê°œ)`;
            } else if (!isReviewMode) {
                 btnReviewMode.classList.add('hidden');
            }
        }
        
        /**
         * ë³µìŠµ ë¬¸ì œ ëª©ë¡ì„ ë Œë”ë§í•˜ì—¬ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤. (ëª©ë¡í˜•)
         */
        function renderReviewList() {
            const reviewData = getReviewQuestions();
            
            // í€´ì¦ˆ UI ìˆ¨ê¸°ê¸°
            quizBox.classList.add('hidden');
            answerButtonsContainer.classList.add('hidden');
            hideFeedback();
            
            reviewItems.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
            reviewListContainer.classList.remove('hidden'); // ëª©ë¡ ì»¨í…Œì´ë„ˆ í‘œì‹œ

            if (reviewData.length === 0) {
                reviewItems.innerHTML = '<p class="text-center text-gray-600 p-8 bg-gray-50 rounded-lg shadow-inner">í˜„ì¬ ì €ì¥ëœ ë³µìŠµ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ì¼ë°˜ í€´ì¦ˆë¥¼ í’€ì–´ë³´ì„¸ìš”!</p>';
                return;
            }

            reviewData.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-5 border-2 border-red-200 bg-white rounded-xl shadow-lg space-y-3';

                // ì •ë‹µ í…ìŠ¤íŠ¸ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
                const correctAnswerText = item.options[parseInt(item.answer) - 1];
                
                // ê° í•­ëª©ì˜ HTML êµ¬ì¡°: ë¬¸ì œ, ì •ë‹µ(ê°•ì¡°), í•´ì„¤
                itemDiv.innerHTML = `
                    <p class="text-lg font-extrabold text-violet-800 border-b-2 border-red-100 pb-2">ë¬¸ì œ ${index + 1}.</p>
                    <p class="text-md font-semibold text-black">${item.question}</p>
                    
                    <div class="p-3 bg-teal-50 rounded-lg">
                        <p class="text-sm font-bold text-teal-800 mb-1">âœ… ì •ë‹µ:</p>
                        <p class="text-sm text-teal-700 font-extrabold">${correctAnswerText}</p>
                    </div>

                    <div class="pt-3 border-t border-gray-200">
                        <p class="text-sm font-bold text-gray-800 mb-1">ğŸ“ í•´ì„¤:</p>
                        <p class="text-sm text-gray-600 leading-relaxed">${item.explanation}</p>
                    </div>
                `;
                reviewItems.appendChild(itemDiv);
            });
            
            // ì ìˆ˜íŒ ì´ˆê¸°í™” (ë³µìŠµ ëª¨ë“œì—ì„œëŠ” ì ìˆ˜ ë¬´ì˜ë¯¸)
            scoreDisplay.textContent = `0 / ${reviewData.length}`;
            totalQuestions = reviewData.length;
        }


        // =================================================================
        // API ë° í€´ì¦ˆ ë¡œì§ ê´€ë ¨ í•¨ìˆ˜
        // =================================================================

        /**
         * ì§€ìˆ˜ ë°±ì˜¤í”„ë¥¼ êµ¬í˜„í•˜ëŠ” Fetch í•¨ìˆ˜ì…ë‹ˆë‹¤.
         * @param {string} url - API URL
         * @param {object} options - Fetch ì˜µì…˜ (method, headers, body ë“±)
         * @param {number} retries - ë‚¨ì€ ì¬ì‹œë„ íšŸìˆ˜
         * @returns {Promise<Response>} Fetch ì‘ë‹µ
         */
        async function fetchWithBackoff(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429 && i < retries - 1) { // Too Many Requests
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
                } catch (error) {
                    if (i === retries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Gemini APIë¥¼ í˜¸ì¶œí•˜ì—¬ í€´ì¦ˆ ë°ì´í„°ë¥¼ ìƒì„±í•˜ê³  ê°€ì ¸ì˜µë‹ˆë‹¤. (API ì‹¤íŒ¨ ì‹œ ì •ì  ë°ì´í„° í´ë°±)
         * @returns {Promise<Array>} í€´ì¦ˆ ë°ì´í„° ë°°ì—´ì„ í¬í•¨í•˜ëŠ” í”„ë¡œë¯¸ìŠ¤
         */
        async function generateQuizData() {
            // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸: 5ê°œì˜ í€´ì¦ˆë¥¼ ìš”ì²­í•˜ë„ë¡ ì„¤ì •ë˜ì–´ ìˆìŒ
            const systemPrompt = "ë‹¹ì‹ ì€ í•œêµ­ì˜ ë²•ë¥  ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì¼ìƒìƒí™œê³¼ ê´€ë ¨ëœ í•œêµ­ ë²•ë¥  ìƒì‹ì— ëŒ€í•œ 5ê°œì˜ 3ì§€ì„ ë‹¤í˜• í€´ì¦ˆë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”. ì§ˆë¬¸, 3ê°œì˜ ì„ íƒì§€(1, 2, 3ìœ¼ë¡œ ì‹œì‘), ì •ë‹µ ë²ˆí˜¸, ìƒì„¸ í•´ì„¤ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤. ìƒì„±ëœ ë‚´ìš©ì€ ì œê³µëœ JSON ìŠ¤í‚¤ë§ˆë¥¼ ì—„ê²©íˆ ë”°ë¥´ì„¸ìš”.";
            const userQuery = "í•œêµ­ ë²•ë¥  ìƒì‹ì— ëŒ€í•œ ìƒˆë¡œìš´ 3ì§€ì„ ë‹¤ í€´ì¦ˆ 5ê°œë¥¼ ìƒì„±í•´ì¤˜.";
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "question": { "type": "STRING", "description": "ë²•ë¥  ìƒì‹ ì§ˆë¬¸." },
                                "options": {
                                    "type": "ARRAY",
                                    "items": { "type": "STRING" },
                                    "description": "ë°˜ë“œì‹œ '1. [ì„ íƒì§€]', '2. [ì„ íƒì§€]', '3. [ì„ íƒì§€]' í˜•ì‹ì˜ 3ê°œ ì„ íƒì§€ì—¬ì•¼ í•©ë‹ˆë‹¤."
                                },
                                "answer": { "type": "STRING", "description": "ì •ë‹µ ì„ íƒì§€ì˜ ë²ˆí˜¸ ('1', '2', ë˜ëŠ” '3')." },
                            "explanation": { "type": "STRING", "description": "ì •ë‹µì— ëŒ€í•œ ìƒì„¸í•œ ë²•ë¥  í•´ì„¤." }
                            },
                            "propertyOrdering": ["question", "options", "answer", "explanation"]
                        }
                    }
                }
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonString = candidate.content.parts[0].text;
                    const parsedJson = JSON.parse(jsonString);
                    
                    if (Array.isArray(parsedJson) && parsedJson.every(q => q.options && q.options.length === 3)) {
                        return parsedJson;
                    } else {
                        console.warn("[í€´ì¦ˆ ìƒì„± ê²½ê³ ] APIì—ì„œ ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„° êµ¬ì¡°ë¥¼ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. ì •ì  ë°ì´í„°ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.");
                        return STATIC_QUIZ_DATA;
                    }
                } else {
                    console.warn("[í€´ì¦ˆ ìƒì„± ê²½ê³ ] API ì‘ë‹µì—ì„œ ì½˜í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •ì  ë°ì´í„°ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.");
                    return STATIC_QUIZ_DATA;
                }
            } catch (error) {
                console.error("[í€´ì¦ˆ ìƒì„± ì˜¤ë¥˜] Gemini API í˜¸ì¶œ ì˜¤ë¥˜ë¡œ ì •ì  ë°ì´í„°ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤:", error);
                
                await new Promise(resolve => setTimeout(resolve, 1500)); 
                return STATIC_QUIZ_DATA;
            }
        }

        /**
         * í€´ì¦ˆë¥¼ ì´ˆê¸°í™”í•˜ê³  ì²« ë¬¸ì œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
         * @param {boolean} startReviewMode - ë³µìŠµ ëª¨ë“œë¡œ ì‹œì‘í• ì§€ ì—¬ë¶€
         */
        async function initializeQuiz(startReviewMode = false) {
            isReviewMode = startReviewMode;
            score = 0;
            isAnswered = false;

            if (isReviewMode) {
                // ë³µìŠµ ëª¨ë“œ (ëª©ë¡í˜• ë·°)
                
                quizBox.classList.add('hidden');
                answerButtonsContainer.classList.add('hidden');
                btnNext.textContent = "ì¼ë°˜ ëª¨ë“œë¡œ ëŒì•„ê°€ê¸°";
                btnNext.disabled = false;
                btnReviewMode.classList.add('hidden');
                hideFeedback();
                
                renderReviewList();
            } else {
                // ì¼ë°˜ ëª¨ë“œ (í€´ì¦ˆ ëª¨ë“œ)
                
                availableQuestions = []; 
                totalQuestions = 0; 
                updateScoreDisplay(); 
                
                // ë²„ê·¸ ìˆ˜ì •: ìƒˆ í€´ì¦ˆ ìƒì„± ì‹œ ì´ì „ ìµœì¢… ì ìˆ˜ ë©”ì‹œì§€ ì´ˆê¸°í™”
                questionText.textContent = "í€´ì¦ˆë¥¼ ì‹œì‘í•˜ë ¤ë©´ 'ì‹œì‘í•˜ê¸°' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”."; 
                
                showLoading(); 
                
                reviewListContainer.classList.add('hidden');

                const MIN_UNIQUE_QUESTIONS_TARGET = 3; // ìµœì†Œí•œ 3ê°œ ì´ìƒì˜ ìƒˆë¡œìš´ ë¬¸ì œë¥¼ í™•ë³´í•˜ë„ë¡ ì‹œë„
                const MAX_API_RETRIES = 3; // API í˜¸ì¶œ ì¬ì‹œë„ íšŸìˆ˜
                let attempt = 0;
                let uniqueQuestionsFound = [];
                let hasApiFailed = false; // API í˜¸ì¶œ ì‹¤íŒ¨ ì—¬ë¶€ í”Œë˜ê·¸
                
                const history = getAskedHistory();
                const askedQuestionsSet = new Set(history);
                
                // ì •ì  ë°ì´í„° ì§ˆë¬¸ í…ìŠ¤íŠ¸ë§Œ ë¯¸ë¦¬ ì¶”ì¶œí•´ Setì— ë„£ì–´, ì •ì  ë°ì´í„° ì¤‘ë³µì„ í”¼í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
                const staticQuestionTexts = new Set(STATIC_QUIZ_DATA.map(q => q.question.trim()));

                // ìƒˆë¡œìš´ ë¬¸ì œë¥¼ ì°¾ê¸° ìœ„í•œ ì¬ì‹œë„ ë£¨í”„
                while (attempt < MAX_API_RETRIES) {
                    try {
                        let quizData = await generateQuizData(); // API í˜¸ì¶œ (ë˜ëŠ” ì •ì  ë°ì´í„°)
                        
                        // ì •ì  ë°ì´í„°ê°€ ì•„ë‹Œ ê²½ìš°, APIê°€ ì‹¤ì œë¡œ ì‘ë‹µí–ˆìŒì„ ê°€ì •
                        if (quizData !== STATIC_QUIZ_DATA) {
                            hasApiFailed = false;
                        }

                        // ì´ë¯¸ ì¶œì œëœ ë¬¸ì œ í•„í„°ë§ (ë¡œì»¬ íˆìŠ¤í† ë¦¬ ê¸°ë°˜)
                        const newlyFilteredQuestions = quizData.filter(q => !askedQuestionsSet.has(q.question.trim()));
                        
                        // í˜„ì¬ê¹Œì§€ ì°¾ì€ ê³ ìœ í•œ ë¬¸ì œ ëª©ë¡ì— ì¶”ê°€ (ì¤‘ë³µ ê²€ì‚¬ë¥¼ í†µí•´ ì¤‘ë³µ ëˆ„ì  ë°©ì§€)
                        const currentUniqueTexts = new Set(uniqueQuestionsFound.map(q => q.question.trim()));
                        
                        newlyFilteredQuestions.forEach(q => {
                            if (!currentUniqueTexts.has(q.question.trim())) {
                                uniqueQuestionsFound.push(q);
                                currentUniqueTexts.add(q.question.trim()); // ì¤‘ë³µ ê²€ì‚¬ìš© Setì—ë„ ì¶”ê°€
                            }
                        });

                        // ëª©í‘œì¹˜ ë‹¬ì„± í™•ì¸
                        if (uniqueQuestionsFound.length >= MIN_UNIQUE_QUESTIONS_TARGET) {
                            // API í˜¸ì¶œ ì„±ê³µ ë° ëª©í‘œì¹˜ ë‹¬ì„± ì‹œ ë£¨í”„ ì¢…ë£Œ
                            console.log(`[í€´ì¦ˆ ìƒì„± ì„±ê³µ] ${attempt + 1}íšŒ ì‹œë„ë§Œì— ${uniqueQuestionsFound.length}ê°œì˜ ìƒˆë¡œìš´ ë¬¸ì œë¥¼ í™•ë³´í–ˆìŠµë‹ˆë‹¤.`);
                            break; 
                        }
                    } catch (error) {
                        console.error("[í€´ì¦ˆ ìƒì„± ì‹¤íŒ¨] API ì¬ì‹œë„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                        hasApiFailed = true;
                    }
                    attempt++;
                }
                
                // 3ë²ˆ ì‹œë„ í›„ì—ë„ ëª©í‘œì¹˜ì— ë„ë‹¬í•˜ì§€ ëª»í–ˆê±°ë‚˜, APIê°€ ì‹¤íŒ¨í•œ ê²½ìš°, ì •ì  ë°ì´í„°ë¥¼ ê°•ì œë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.
                if (uniqueQuestionsFound.length < MIN_UNIQUE_QUESTIONS_TARGET || hasApiFailed) {
                    console.warn(`[ìµœì¢… ëŒ€ì²´] APIë¥¼ í†µí•´ ${uniqueQuestionsFound.length}ê°œ í™•ë³´. ì •ì  ë°ì´í„°ì—ì„œ ë³´ì¶© ì‹œë„.`);
                    
                    const currentUniqueTexts = new Set(uniqueQuestionsFound.map(q => q.question.trim()));
                    
                    STATIC_QUIZ_DATA.forEach(q => {
                        // ì •ì  ë°ì´í„°ì´ë©´ì„œ ë¡œì»¬ íˆìŠ¤í† ë¦¬ì— ì—†ê³ , í˜„ì¬ í™•ë³´í•œ ëª©ë¡ì—ë„ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì¶”ê°€
                        if (!askedQuestionsSet.has(q.question.trim()) && !currentUniqueTexts.has(q.question.trim())) {
                            uniqueQuestionsFound.push(q);
                            currentUniqueTexts.add(q.question.trim());
                        }
                    });
                }
                
                availableQuestions = uniqueQuestionsFound;
                totalQuestions = availableQuestions.length; 
                
                // â­ ì¶œì œëœ ë¬¸ì œ ê¸°ë¡ ì—…ë°ì´íŠ¸
                if (totalQuestions > 0) {
                    updateAskedHistory(availableQuestions);
                }


                btnNext.textContent = "ë‹¤ìŒ ë¬¸ì œ";
                setAnswerButtonsEnabled(true);
                
                if (totalQuestions === 0) {
                    if (history.length >= STATIC_QUIZ_DATA.length) {
                         questionText.textContent = "ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ì•±ì— ë“±ë¡ëœ ëª¨ë“  ë¬¸ì œë¥¼ ë‹¤ í’€ì—ˆìŠµë‹ˆë‹¤. ìºì‹œë¥¼ ì§€ìš°ê±°ë‚˜ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•˜ë©´ ìƒˆë¡œìš´ ë¬¸ì œê°€ ìƒì„±ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
                    } else if (hasApiFailed) {
                        questionText.textContent = `ì˜¤ë¥˜ ë°œìƒ: í€´ì¦ˆ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (API ì˜¤ë¥˜)`;
                    } else {
                        questionText.textContent = "ìƒˆë¡œìš´ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜, ìºì‹œë¥¼ ì§€ìš°ë©´ ë” ê´‘ë²”ìœ„í•œ ìƒˆ ë¬¸ì œë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
                    }
                    btnNext.textContent = "ë‹¤ì‹œ ì‹œì‘";
                    setAnswerButtonsEnabled(false);
                } else {
                    loadRandomQuestion();
                }

                hideLoading();
            }
            
            if (!isReviewMode || availableQuestions.length > 0) {
                 updateScoreDisplay(); 
            }
            updateReviewModeUI();
            
            if (!isReviewMode) {
                btnReviewMode.classList.toggle('hidden', getReviewQuestions().length === 0);
            }
        }

        /**
         * ë‹µë³€ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ìƒíƒœë¥¼ ì„¤ì •í•˜ê³  ë°°ê²½ìƒ‰ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
         * @param {boolean} enabled - trueë©´ í™œì„±í™”, falseë©´ ë¹„í™œì„±í™”
         */
        function setAnswerButtonsEnabled(enabled) {
            choiceButtons.forEach(button => {
                button.element.disabled = !enabled;
                // ë°°ê²½ìƒ‰ ì´ˆê¸°í™”
                button.element.classList.remove('btn-correct', 'btn-incorrect', 'btn-subdued');
                button.element.classList.add('btn-choice'); 
            });
        }

        /**
         * ì ìˆ˜ í‘œì‹œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateScoreDisplay() {
            scoreDisplay.textContent = `${score} / ${totalQuestions}`; // ì´ ë¬¸ì œ ìˆ˜ í¬í•¨
        }

        /**
         * ëœë¤ìœ¼ë¡œ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì™€ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function loadRandomQuestion() {

            hideFeedback();
            isAnswered = false;
            setAnswerButtonsEnabled(true);
            
            btnNext.disabled = true; 

            if (availableQuestions.length === 0) {
                showQuizEndMessage();
                return;
            }

            const randomIndex = Math.floor(Math.random() * availableQuestions.length);
            currentQuestion = availableQuestions[randomIndex];
            
            // ì¶œì œëœ ë¬¸ì œë¥¼ ëª©ë¡ì—ì„œ ì œê±° (ë³µìŠµ ëª¨ë“œì—ì„œë„ ë™ì¼í•˜ê²Œ ì ìš©í•˜ì—¬ ë¬¸ì œ ìˆœí™˜)
            availableQuestions.splice(randomIndex, 1);

            questionText.textContent = `Q. ${currentQuestion.question}`;
            choiceButtons.forEach((button, index) => {
                button.element.textContent = currentQuestion.options[index];
            });
            
            // í€´ì¦ˆ UI í‘œì‹œ
            quizBox.classList.remove('hidden');
            questionText.classList.remove('hidden');
            answerButtonsContainer.classList.remove('hidden');
        }

        /**
         * ì‚¬ìš©ìì˜ ë‹µë³€ì„ ì²´í¬í•˜ê³  í”¼ë“œë°±ì„ í‘œì‹œí•©ë‹ˆë‹¤.
         * @param {string} userAnswerChoice - ì‚¬ìš©ìê°€ ì„ íƒí•œ ì„ íƒì§€ì˜ ë²ˆí˜¸ ('1', '2', '3')
         * @param {HTMLElement} userButton - ì‚¬ìš©ìê°€ ëˆ„ë¥¸ ë²„íŠ¼ ì—˜ë¦¬ë¨¼íŠ¸
         */
        function checkAnswer(userAnswerChoice, userButton) {
            if (isAnswered || !currentQuestion) return; 
            
            isAnswered = true;
            setAnswerButtonsEnabled(false); 
            btnNext.disabled = false; 

            const isCorrect = (userAnswerChoice === currentQuestion.answer);
            const correctAnswerIndex = parseInt(currentQuestion.answer) - 1;
            const correctButton = choiceButtons[correctAnswerIndex].element;

            // ëª¨ë“  ë²„íŠ¼ì—ì„œ ì´ˆê¸°í™”ëœ ìƒ‰ìƒ ì œê±°
            choiceButtons.forEach(button => {
                button.element.classList.remove('btn-choice');
                button.element.classList.remove('btn-subdued'); // Subdued ìŠ¤íƒ€ì¼ë„ ì œê±°
            });

            if (isCorrect) {
                score++;
                updateScoreDisplay();
                showFeedback(true, "ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰");
                userButton.classList.add('btn-correct');
                
                // ì •ë‹µ ì„ íƒ ì‹œ, ì •ë‹µ ë²„íŠ¼ì„ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ë²„íŠ¼ì„ íë¦¿í•˜ê²Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                choiceButtons.forEach(button => {
                    if (button.element !== userButton) {
                        button.element.classList.add('btn-subdued');
                    }
                });
                
                // ë³µìŠµ ëª¨ë“œì¸ ê²½ìš°, ë§ì¶˜ ë¬¸ì œëŠ” ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œë„ ì œê±°
                if (isReviewMode) {
                    let questions = getReviewQuestions();
                    // í˜„ì¬ ë¬¸ì œì™€ question í•„ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ë¬¸ì œë“¤ë§Œ í•„í„°ë§í•˜ì—¬ ë‹¤ì‹œ ì €ì¥
                    const newQuestions = questions.filter(q => q.question.trim() !== currentQuestion.question.trim());
                    localStorage.setItem(REVIEW_STORAGE_KEY, JSON.stringify(newQuestions));
                    updateReviewModeUI();
                }
            } else {
                showFeedback(false, `ì˜¤ë‹µì…ë‹ˆë‹¤. ğŸ˜¥ ì •ë‹µì€ '${correctButton.textContent}'ì…ë‹ˆë‹¤.`);
                userButton.classList.add('btn-incorrect'); // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì˜¤ë‹µì€ ë¹¨ê°„ìƒ‰
                correctButton.classList.add('btn-correct'); // ì •ë‹µì€ ë…¹ìƒ‰
                
                // ì˜¤ë‹µ ì„ íƒ ì‹œ, ì„ íƒí•˜ì§€ ì•Šì€ ë‚˜ë¨¸ì§€ í•œ ê°œì˜ ë²„íŠ¼ë„ íë¦¿í•˜ê²Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                choiceButtons.forEach(button => {
                    if (button.element !== userButton && button.element !== correctButton) {
                        button.element.classList.add('btn-subdued');
                    }
                });
                
                // ì¼ë°˜ ëª¨ë“œì¸ ê²½ìš°, í‹€ë¦° ë¬¸ì œëŠ” ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•˜ì—¬ ë³µìŠµ ë¬¸ì œë¡œ ë§Œë“­ë‹ˆë‹¤.
                if (!isReviewMode) {
                    saveIncorrectQuestion(currentQuestion);
                }
            }

            // í•´ì„¤ í‘œì‹œ
            explanationText.textContent = `[í•´ì„¤] ${currentQuestion.explanation}`;
        }

        /**
         * í”¼ë“œë°± ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function showFeedback(isCorrect, message) {
            
            // ì´ì „ ìƒ‰ìƒ/í…Œë‘ë¦¬ í´ë˜ìŠ¤ ë° hidden ìƒíƒœ ì œê±° (green/teal/red ëª¨ë‘ ì œê±°)
            feedbackContainer.classList.remove(
                'hidden', 
                'bg-red-100', 'border-red-400', 
                'bg-green-100', 'border-green-400',
                'bg-teal-100', 'border-teal-400'
            );
            
            // í”¼ë“œë°± ë©”ì‹œì§€ í…ìŠ¤íŠ¸ ìƒ‰ìƒ í´ë˜ìŠ¤ë„ í™•ì‹¤íˆ ì œê±°
            feedbackMessage.classList.remove('text-red-700', 'text-green-700', 'text-teal-700');
            
            let colorClass, borderColorClass, messageColorClass;
            
            if (isCorrect) {
                // ì •ë‹µ: ì£¼ í…Œë§ˆì¸ ì²­ë¡ìƒ‰(Teal) ê³„ì—´ ì‚¬ìš©
                colorClass = 'bg-teal-100';
                borderColorClass = 'border-teal-400';
                messageColorClass = 'text-teal-700';
            } else {
                // ì˜¤ë‹µ: ê²½ê³ ìƒ‰ì¸ ë¹¨ê°„ìƒ‰(Red) ê³„ì—´ ì‚¬ìš©
                colorClass = 'bg-red-100';
                borderColorClass = 'border-red-400';
                messageColorClass = 'text-red-700';
            }

            // í”¼ë“œë°± ì»¨í…Œì´ë„ˆì— í´ë˜ìŠ¤ ì ìš©
            feedbackContainer.classList.add(colorClass, borderColorClass, 'border');
            
            // í”¼ë“œë°± ë©”ì‹œì§€ì— í´ë˜ìŠ¤ ì ìš©
            feedbackMessage.classList.add(messageColorClass);
            
            feedbackMessage.textContent = message;
        }

        /**
         * í”¼ë“œë°± ë©”ì‹œì§€ ì˜ì—­ì„ ìˆ¨ê¹ë‹ˆë‹¤.
         */
        function hideFeedback() {
            feedbackContainer.classList.add('hidden');
        }

        /**
         * í€´ì¦ˆ ì¢…ë£Œ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function showQuizEndMessage() {
            questionText.textContent = `ëª¨ë“  ë¬¸ì œë¥¼ ë‹¤ í’€ì—ˆìŠµë‹ˆë‹¤! ìµœì¢… ì ìˆ˜ëŠ” ${score} / ${totalQuestions}ì ì…ë‹ˆë‹¤.`;
            currentQuestion = null; 
            setAnswerButtonsEnabled(false);
            hideFeedback();
            
            if (isReviewMode) {
                 btnNext.textContent = "ì¼ë°˜ ëª¨ë“œë¡œ ëŒì•„ê°€ê¸°";
            } else {
                 btnNext.textContent = "ìƒˆ í€´ì¦ˆ ìƒì„±";
                 updateReviewModeUI(); // ì¼ë°˜ ëª¨ë“œ ì¢…ë£Œ ì‹œ ë³µìŠµ ëª¨ë“œ ë²„íŠ¼ì„ ë‹¤ì‹œ í‘œì‹œí• ì§€ ê²°ì •
            }
            btnNext.disabled = false;
        }


        // =================================================================
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        // =================================================================

        // 3ì§€ì„ ë‹¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        choiceButtons.forEach(buttonInfo => {
            buttonInfo.element.addEventListener('click', () => {
                if (currentQuestion) {
                     checkAnswer(buttonInfo.choice, buttonInfo.element); 
                }
            });
        });

        // 'ë‹¤ìŒ ë¬¸ì œ'/'ì‹œì‘í•˜ê¸°'/'ì¬ì‹œì‘' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        btnNext.addEventListener('click', () => {
            const buttonText = btnNext.textContent.trim(); 

            if (buttonText === "ìƒˆ í€´ì¦ˆ ìƒì„±" || buttonText === "ì‹œì‘í•˜ê¸°" || buttonText === "ì˜¤ë¥˜ ë°œìƒ" || buttonText === "ì¼ë°˜ ëª¨ë“œë¡œ ëŒì•„ê°€ê¸°" || buttonText === "ë‹¤ì‹œ ì‹œì‘") {
                // ë³µìŠµ ëª¨ë“œì—ì„œ ëŒì•„ì˜¤ê±°ë‚˜ ìƒˆë¡œ ì‹œì‘í•  ë•ŒëŠ” ì¼ë°˜ ëª¨ë“œ(false)ë¡œ ì´ˆê¸°í™”
                initializeQuiz(false); 
            } else if (buttonText === "ë‹¤ìŒ ë¬¸ì œ" && !btnNext.disabled) {
                loadRandomQuestion();
            }
        });

        // ë³µìŠµ ëª¨ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
        btnReviewMode.addEventListener('click', () => {
            initializeQuiz(true);
        });

        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        setAnswerButtonsEnabled(false);
        updateScoreDisplay(); 
        updateReviewModeUI(); // ë³µìŠµ ëª¨ë“œ ë¬¸ì œ ìˆ˜ ì´ˆê¸°í™” ë° ë²„íŠ¼ ìƒíƒœ ì„¤ì •

    </script>
</body>
</html>
